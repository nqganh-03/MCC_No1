%% ƒê·ªçc c√°c file √¢m thanh
[x_ref, fs] = audioread('group_record.wav');              % file g·ªëc
[x_mp3, ~] = audioread('group_record_128kbps.mp3');       % file MP3
[x_celp, ~] = audioread('decompressed.wav');              % file CELP (gi·ªØ 1 k√™nh n·∫øu stereo)
x_ref = x_ref(:,1);
x_mp3 = x_mp3(:,1);
x_celp = x_celp(:,1);

% C·∫Øt t√≠n hi·ªáu c√πng ƒë·ªô d√†i
min_len = min([length(x_ref), length(x_mp3), length(x_celp)]);
x_ref = x_ref(1:min_len);
x_mp3 = x_mp3(1:min_len);
x_celp = x_celp(1:min_len);

%% T√≠nh PSNR t·ªïng th·ªÉ
psnr_fn = @(x, y) 10 * log10(max(x.^2) / mean((x - y).^2));
psnr_mp3 = psnr_fn(x_ref, x_mp3);
psnr_celp = psnr_fn(x_ref, x_celp);

fprintf('\‚ô• PSNR MP3: %.2f dB\n', psnr_mp3);
fprintf('\‚ô• PSNR CELP: %.2f dB\n\n', psnr_celp);

%% T√≠nh PSNR theo t·ª´ng khung
frame_size = round(0.02 * fs);    % 20ms per frame
overlap = round(0.01 * fs);       % 10ms overlap
hop = frame_size - overlap;
num_frames = floor((min_len - overlap) / hop);

psnr_mp3_all = zeros(num_frames,1);
psnr_celp_all = zeros(num_frames,1);

for i = 1:num_frames
    start = (i-1)*hop + 1;
    frame_ref = x_ref(start : start + frame_size - 1);
    frame_mp3 = x_mp3(start : start + frame_size - 1);
    frame_celp = x_celp(start : start + frame_size - 1);
    
    mse_mp3 = mean((frame_ref - frame_mp3).^2);
    mse_celp = mean((frame_ref - frame_celp).^2);
    max_val = max(frame_ref.^2);  % d√πng c√πng 1 max ƒë·ªÉ c√¥ng b·∫±ng
    
    psnr_mp3_all(i) = 10 * log10(max_val / mse_mp3);
    psnr_celp_all(i) = 10 * log10(max_val / mse_celp);
end

%% V·∫Ω bi·ªÉu ƒë·ªì PSNR
figure;
plot(psnr_mp3_all, 'r'); hold on;
plot(psnr_celp_all, 'b');
legend('MP3', 'CELP');
xlabel('Ch·ªâ s·ªë khung (Frame Index)');
ylabel('PSNR (dB)');
title('So s√°nh PSNR gi·ªØa MP3 v√† CELP theo t·ª´ng khung');
grid on;

%% Hi·ªÉn th·ªã th·ªëng k√™ PSNR
fprintf('\nüìä Th·ªëng k√™ PSNR t·ª´ng khung:\n');
fprintf('MP3  - Trung b√¨nh: %.2f dB | Min: %.2f | Max: %.2f | Std: %.2f\n', ...
    mean(psnr_mp3_all), min(psnr_mp3_all), max(psnr_mp3_all), std(psnr_mp3_all));
fprintf('CELP - Trung b√¨nh: %.2f dB | Min: %.2f | Max: %.2f | Std: %.2f\n', ...
    mean(psnr_celp_all), min(psnr_celp_all), max(psnr_celp_all), std(psnr_celp_all));

fprintf('\n‚úÖ PSNR MP3: %.2f dB\n', psnr_mp3);
fprintf('‚úÖ PSNR CELP: %.2f dB\n', psnr_celp);
